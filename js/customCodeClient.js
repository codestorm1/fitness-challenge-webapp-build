define("customCodeClient",["jquery"],function(e){var t=this;return{formatDate:function(e){var t=e.getDate(),n=e.getMonth()+1,r=e.getFullYear(),i=n+"/"+t+"/"+r;return i},getQueryVariable:function(e,t){var n=e.split("?");if(n.length>1){var r=n[1].split("&");for(var i=0;i<r.length;i++){var s=r[i].split("=");if(s[0]==t)return s[1]}}return null},showMessage:function(e){alert(e)},getNextUserID:function(e){var t=StackMob.Model.extend({schemaName:"user_id_counter"}),n=new t({user_id_counter_id:"1"});n.fetch({success:function(t){t.incrementOnSave("current_id",1),t.save({},{success:function(t){if(typeof e=="function"){var n=t.get("current_id");n?e(!0,n):e(!1)}},error:function(t,n){console.debug("Aww...why did you fail on me?! "+n.error),typeof e=="function"&&e(!1)}})},error:function(t,n){console.debug(n),typeof e=="function"&&e(!1)}})},getFitbitRequestToken:function(e,t){if(typeof t!="function")throw"callback is required";StackMob.customcode("fetch_fitbit_request_token",{stackmob_user_id:e},{success:function(e){t(!0,e)},error:function(e){t(!1,e)}})},getFitbitAccessToken:function(e,t,n,r){if(typeof r!="function")throw"callback is required";var i={request_token:e,request_token_secret:t,oauth_verifier:n};StackMob.customcode("fetch_fitbit_access_token",i,"GET",{success:function(e){r(!0,e)},error:function(e){r(!1,e)}})},getFitbitUser:function(e,t,n,r){if(typeof r!="function")throw"callback is required";var i={access_token:e,access_token_secret:t,fitbit_user_id:n};StackMob.customcode("fetch_fitbit_user",i,"GET",{success:function(e){var t=e.userInfoJson,n=JSON.parse(t).user;r(!0,n)},error:function(e){r(!1,e)}})},lookupFitnessUser:function(e,t,n){if(typeof n!="function")throw"callback is required";var r=this;if(!e){typeof n=="function"&&n(!1,"email address is required");return}var i=StackMob.Model.extend({schemaName:"user"}),s=StackMob.Collection.extend({model:i}),o=new s,u=new StackMob.Collection.Query;u.equals("email",e),t&&u.equals("fc_password",t),o.query(u,{success:function(e){e.length==1?n(!0,e.models[0]):n(!1,"Could not find user with given email and password")},error:function(e){r.showMessage("query failed trying to get user "+e),console.debug(e),n(!1,e)}})},createStackmobUser:function(e,t,n){var r=this;typeof n!="function"&&(n=function(){}),r.lookupFitnessUser(e,t,function(i,s){if(i){n(!1,"That email address is already in use");return}r.getNextUserID(function(r,i){if(r){var s={email:e,password:t,fc_password:t,username:i.toString()},o=new StackMob.User(s);o.create({success:function(e){console.debug("user object is saved"),n(!0,e)},error:function(e,t){console.debug(t),n(!1,"failed to save user to datastore")}})}else n(!1,"Failed to get next StackMob user ID")})})},updateUserWithParams:function(e,t,n){if(typeof n!="function")throw"callback is required";delete t.encodedid;for(var r in t)t.hasOwnProperty(r)&&e.set(r,t[r]);var i=new StackMob.User({username:e.get("username")});i.save(e,{success:function(e){n(!0,e)},error:function(e,t){console.debug(t),n(!1,t)}})},getFitbitFriends:function(e,t){var n=this;StackMob.customcode("fetch_fitbit_friends",{stackmob_user_id:e},"GET",{success:function(e){var n=e.friendsJson,r=JSON.parse(n).friends;typeof t=="function"&&t(!0,r)},error:function(e){typeof t=="function"&&t(!1,e)}})},showFriends:function(t){var n="",r=t.length,i;for(var s=0;s<r;s++){i=t[s].user;for(var o in i)n+=o+": "+i[o]+"<br>\n"}e("#results").html(n)},getFriends:function(e){this.user.get("friends")},saveFriendsToStackmob:function(e,t,n){if(typeof n!="function")throw"callback is required";t||n(!1,"no friends to update");var r=this,i=[],s=t.length;for(var o=0;o<s;o++){var u=t[o].user;i.push(u.encodedId)}var a=StackMob.Model.extend({schemaName:"user"}),f=StackMob.Collection.extend({model:a}),l=new f,c=new StackMob.Collection.Query;c.mustBeOneOf("fitbituserid",i),l.query(c,{success:function(t){var r=[];if(t.models.length>0){s=t.models.length;for(var o=0;o<s;o++){var u=t.models[o];r.push(u.get("username"))}}var a=new StackMob.User({username:e}),f={friends:r,friendcount:r.length,fitbitfriendcount:i.length};a.save(f,{success:function(e){n(!0,e)},error:function(e,t){console.debug(t),n(!1,t)}})},error:function(e){console.debug(response),n(!1,response)}})},updateActivities:function(e,t){var n=new Date,r=new Date(n.getTime()-5184e5),i={stackmob_user_id:e,start_date:this.formatDate(r),end_date:this.formatDate(n)};StackMob.customcode("update_fitbit_activities",i,{success:function(e){console.debug("tokens response: "+JSON.stringify(e)),typeof t=="function"&&t(!0,e)},error:function(e){typeof t=="function"&&t(!1,e)}})},completeFitbitAuth:function(e,t,n,r,i){var s=this;this.getFitbitAccessToken(t,n,r,function(t,n){t?s.getFitbitUser(n.oauth_token,n.oauth_token_secret,n.fitbit_user_id,function(t,r){if(t){console.debug("get fitbit user response: "+JSON.stringify(r)),delete r.encodedID;var o=r;o.accesstoken=n.oauth_token,o.accesstokensecret=n.oauth_token_secret,o.fitbituserid=n.fitbit_user_id,s.updateUserWithParams(e,o,function(e,t){e?i(!0,t):i(!1,"failed to update with fitbit info\n "+t.error)})}else i(!1,"failed to get Fitbit User: "+r)}):i(!1,"failed to get Fitbit access token")})},loginWithID:function(e,t){if(typeof t!="function")throw"callback is required";if(e){var n=new StackMob.User({username:e});n.fetch({success:function(e){console.debug("login response: "+JSON.stringify(e.toJSON())),t(!0,e)},error:function(e){t(!1,"could not retrieve your data"+e)}})}},getChallengeInvites:function(e,n){if(typeof n!="function")throw"callback is required";var r=StackMob.Model.extend({schemaName:"invitation"}),i=StackMob.Collection.extend({model:r}),s=new i,o=new StackMob.Collection.Query;o.equals("inviteduser",e),o.equals("responded",!1),o.setExpand(1),s.query(o,{success:function(e){var t=e.models.length;console.debug("invitation response: "+JSON.stringify(e.toJSON()));if(t===0){n(!0,e);return}n(!0,e)},error:function(e,r){t.showMessage("query failed trying to get user "+r),console.debug(r),n(!1,r)}})},getChallenges:function(e,t){if(typeof t!="function")throw"callback is required";var n=StackMob.Model.extend({schemaName:"challenge"}),r=StackMob.Collection.extend({model:n}),i=new r,s=new StackMob.Collection.Query;s.mustBeOneOf("users",e),i.query(s,{success:function(e){console.debug("challenges response: "+JSON.stringify(e.toJSON())),t(!0,e)},error:function(e){console.debug(e),t(!1,e)}})}}});