define("routers/FitnessRouter",["jquery","backbone","fitness","customCodeClient","models/ChallengeModel","views/FooterView","views/HomeView","views/FriendsView","views/LoginView","views/RegisterView","views/ProfileView","views/AuthView","views/ChallengeView","views/ChallengeListView","views/InvitationView","views/InvitationListView","jquerymobile"],function(e,t,n,r,i,s,o,u,a,f,l,c,h,p,d,v,m){var g=t.Router.extend({initialize:function(){this.loginView=new a({el:"#login"}),this.registerView=new f({el:"#register"}),t.history.start()},routes:{"":"whereTo",home:"showHome",login:"showLogin",challenge_list:"showChallengeList",invitation_list:"showInvitationList","invitation/:invitation_id":"showInvitation",create:"showCreate",profile:"showProfile",friends:"showFriends",register:"showRegister",auth:"showAuth"},ensureLogin:function(e){if(n.isLoggedIn()){e(!0);return}var t=localStorage.getItem("username");if(!t){e(!1);return}n.loginWithID(t,function(t){e(t);return})},whereTo:function(){var e=this;this.ensureLogin(function(t){if(!t){e.showLogin();return}if(n.user&&n.user.get("accesstoken"))e.showHome();else if(window.location.href.indexOf("oauth_token")!==-1){var i=localStorage.getItem("request_token");i||(n.showMessage("Missing Fitbit request token."),this.showAuth());var s=localStorage.getItem("request_token_secret"),o=r.getQueryVariable(window.location.href,"oauth_verifier"),u=o.length-1;o[u]==="/"&&(o=o.substring(0,u).replace("#","")),r.completeFitbitAuth(n.user,i,s,o,function(e,t){if(e){var r=t;n.user.set("accesstoken",r.oauth_token),n.user.set("accesstokensecret",r.oauth_token_secret),n.user.set("fitbituserid",r.fitbit_user_id),localStorage.removeItem("request_token"),localStorage.removeItem("request_token_secret"),window.location.href="/#home"}else localStorage.removeItem("request_token"),localStorage.removeItem("request_token_secret"),n.showMessage(t)})}else e.showAuth()})},showHome:function(){var t=this;this.ensureLogin(function(r){if(!r){t.showLogin();return}var i=n.user.get("username");n.updateIfStale(i,function(r,i){if(n.user&&n.user.get("accesstoken")){t.homeView=new o({el:"#home"});var u=new s({el:"#home .footer"});e.mobile.changePage("#home",{reverse:!0,changeHash:!0})}else t.showAuth()})})},showChallengeList:function(){var t=this,i="#challenge_list",o=i+" .footer";this.ensureLogin(function(u){t.challengesView?e.mobile.changePage(i,{reverse:!1,changeHash:!0}):(e.mobile.showPageLoadingMsg(),r.getChallenges(n.user.get("username"),function(r,u){r?n.challenges=u:n.showMessage("Failed to get challenges"),t.challengesView=new p({el:i,model:n.challenges});var a=new s({el:o});e.mobile.changePage(i,{reverse:!1,changeHash:!0}),e.mobile.showPageLoadingMsg()}))})},showInvitationList:function(){function o(){e.mobile.changePage(r,{reverse:!1,changeHash:!0})}var t=this,r="#invitation_list",i=r+" .footer";this.ensureLogin(function(u){t.invitationsView?o():(e.mobile.showPageLoadingMsg(),n.getInvitations(n.user.get("username"),!1,function(e,u){if(!e){n.showMessage("Failed to load invitations");return}t.invitationsView=new v({el:r,model:u});var a=new s({el:i});o()}))})},showInvitation:function(t){var r=this,i="#invitation",o=i+" .footer";this.ensureLogin(function(u){var a=function(){e.mobile.changePage(i,{reverse:!1,changeHash:!0}),e.mobile.showPageLoadingMsg()};r.invitationView?a():n.getInvitations(n.user.get("username"),!0,function(e){if(!e){n.showMessage("Failed to load invitations");return}r.invitationView=new d({el:"#invitation",model:n.invitationLookup[t]});var i=new s({el:o});a()})})},showProfile:function(){var t=this;this.ensureLogin(function(n){if(!t.profileView){t.profileView=new l({el:"#profile"});var r=new s({el:"#profile .footer"})}e.mobile.changePage("#profile",{reverse:!1,changeHash:!0}),e.mobile.showPageLoadingMsg()})},showLogin:function(){var t=new s({el:"#login .footer"});e.mobile.changePage("#login",{reverse:!1,changeHash:!0}),e.mobile.showPageLoadingMsg()},showRegister:function(){var t=new s({el:"#register .footer"});e.mobile.changePage("#register",{reverse:!1,changeHash:!0}),e.mobile.showPageLoadingMsg()},showAuth:function(){var t=this;this.ensureLogin(function(n){if(!n){t.showLogin();return}if(!t.authView){var r=new s({el:"#auth .footer"});t.authView=new c({el:"#auth"}),e.mobile.changePage("#auth",{reverse:!1,changeHash:!0}),e.mobile.showPageLoadingMsg()}else e.mobile.changePage("#auth",{reverse:!1,changeHash:!0}),e.mobile.showPageLoadingMsg()})},showCreate:function(){var t=this;this.ensureLogin(function(n){if(!n){t.showLogin();return}if(!t.challengeView){e.mobile.showPageLoadingMsg(),t.challengeView=new h({el:"#create"});var r=new s({el:"#create .footer"});e.mobile.changePage("#create",{reverse:!1,changeHash:!0})}else e.mobile.changePage("#create",{reverse:!1,changeHash:!0})})},showFriends:function(){var t=this;this.ensureLogin(function(r){if(!r){t.showLogin();return}t.friendsView?e.mobile.changePage("#friends",{reverse:!1,changeHash:!0}):(e.mobile.showPageLoadingMsg(),n.updateFitbitFriends(n.user.get("username"),function(n,r){if(n){t.friendsView=new u({el:"#friends"});var i=new s({el:"#friends .footer"});e.mobile.changePage("#friends",{reverse:!1,changeHash:!0})}}))})}});return g});